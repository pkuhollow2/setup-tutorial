# 如何搭建一个树洞
## 基于 webhole 和 nameless3 等

首先，**这个文档仅供参考，不保证最新，不保证正确，部分内容可能借鉴 AI 输出**。阅读时请有自己的思考，感谢你的阅读，欢迎提出建议！

本文档主要内容（第〇章除外）是写给【开发者】的，其他管理人员的使用文档另行编写。

感谢 P 大树洞、T 大树洞、老未名树洞的开源，pkuhollow2 项目以及本文档因此得以诞生。

# 第〇章 先决条件
## 第一节 一般条件

如果你在看这个文档，可能或多或少你对搭建树洞有着一定的【兴趣】。因此，首先需要强调的是：**兴趣是最好的导师，实践是检验真理的唯一标准**。阁主艾姬多娜实践证明，只要有兴趣，并且有一点点计算机基础，在如今各种 AI 工具，尤其是 LLM （大语言模型）的帮助下，一个人就能搭建并运营树洞。艾姬多娜编写这个文档，也是为了降低对基础的要求。艾姬多娜坚信，每一位 Level 0 都有潜力学习和使用“超能力”。（不过，**遇到不清楚之处，请积极询问更了解计算机的朋友，或询问 AI 工具并检查信息来源**。）

不过，**搭建并【长期】运营一个树洞是一个工作量巨大并且难度很高的事情**。树洞的长期运营是一个一定需要一支团队才可以胜任的任务，并且这个团队至少需要有以下几点能力：

- 技术：搭建树洞、树洞*功能更新*时都需要技术能力
- 网络安全：树洞的*隐私保护*是重中之重，也是树洞用户非常关心的问题
- 日常管理：团队中最好需要管理员 7 * 24 小时值班管理树洞，管理员还需要有极高的舆情处理能力，同时看得懂*各种黑话* 😋
- 法务：日常管理中遇到的各种问题都可能需要*法务*帮忙

**在你想要开始搭建树洞之前，请确保你身边有一群你们相互信任的伙伴，你们的合力可以覆盖上面几点能力**。艾姬多娜内心：我怎么找不到这样一群小伙伴，只能在独守“圣域”干等。

## 第二节 技术人员（开发者）

经过长期“沉淀”和多轮分岔（fork），树洞的技术栈目前已经较为复杂，后端使用的是 Linux + Nginx + MySQL + Redis + Go；Web 前端（后续提及“前端”，如无特殊说明，指 Web 前端）使用的是 React；Android 前端主要是 Kotlin；iOS 前端是 SwiftUI。

树洞的“**最小搭建**”（minimal setup）包括 Web 前端和服务器后端。如果至少要完成树洞的 minimal setup，技术人员**至少需要掌握**：

- Linux 的基本使用方法和常用 bash 命令，比如 vim or nano, top, ps, tmux
- 基础网络协议知识，如 HTTP 协议等
- 基础的密码学知识，至少需要可以看懂 https://github.com/treehollow/treehollow-v3-encryption-doc （TODO 更新密码学文档并更改链接）
- 熟悉 git, cron or systemd
- 最好了解一下 Nginx, MySQL, Golang, HTML, CSS, JavaScript, React 等的基础知识，最好能编写最简单的程序/页面，脑海中有印象
- 保持信息安全意识，例如不要随便把服务器 IP 和密钥等发在 Signal 群聊里（紧跟时事）


如果你掌握了这些基础，那么请继续往下看吧！没掌握也没关系，艾姬多娜会准备简易教程的。**从什么都没有，到搭建起树洞大约需要三天的时间，其中包括 DNS 更新等等待时间，请保持耐心。**

## 第三节 超级管理

*注意，这里的“超级管理员”不是 Linux 的 sudoer*

超级管理员拥有诸多权限，例如几乎无限制的删帖禁言额度，对树洞或评论打 tag，查看特定消息的发帖者的个人信息的密文（加密后的结果）（需要第四节所述的密钥保管员方可解密），查看所有用户的系统消息，查看所有举报、删帖禁言等记录。

超级管理员无需多人担任。树洞的首位用户自动成为超级管理员。超级管理员没有特别的技术要求，但要保持信息安全意识。

## 第四节 密钥保管

树洞使用 Shamir 密钥分发算法保护用户的个人信息。简而言之，服务器需要 n 个密钥保管员，并在开始运营前设定阈值 k (0 < k < n)。当需要解密个人信息时，从超级管理员获得特定用户个人信息的密文。当 k 名以上密钥保管员同意解密时，解密方可成功。

密钥保管员需能够使用兼容 OpenPGP 标准的软件，能完成密钥生成、签名、验证签名、加密、解密等基本操作。至少对基础的密码学知识有大体上正确的感觉。

密钥保管员**必须**保持信息安全意识，操作密钥的设备必须使用主流正版操作系统（主流 GNU/Linux, MacOS, Windows），不安装病毒、间谍、恶意、盗版、破解、已知名声不佳的软件，最好使用单独的**永久离线设备**进行密钥相关操作。密钥保管员**必须**多人担任。

## 第五节 其他管理

一般管理员、大审核员、小审核员等拥有相比超级管理员更少的权限，例如每日数次的删帖禁言额度，对树洞或评论打 tag。这些管理员没有特别的技术要求，但要保持信息安全意识。

## 以上所有人员

以上所有角色不必完全分离，但同一个人担任过多职务会增加单点故障的风险。

以上所有人员都要保持信息安全意识，因为你们手握权力。信息安全包括服务器的安全，也包括个人的信息安全。本文档中没有严格辨析信息安全、网络安全、隐私保护等概念，只在需要的地方笼统提及。（TODO 另编简易信息安全文档）

如果树洞的存在本身就会威胁以上所有人员的人身安全（嘘），请
- 至少购买不需要实名制备案的域名、服务器。
- 任何对树洞域名的直接连接不可接受，任何与你关联的网络服务 (如学校邮箱) 与服务器有信息往来都是不可接受的（艾姬多娜备注：pkuhollow2 正在弃用邮件验证码注册，转向 DKIM 验证等更加隐私友好的注册、注销方式）。
- 开发者将有额外要求，将在本文档后续提及。

---

*由 pkuhollow2 阁主兼开发者：艾姬多娜梦游圣域 (Echidna in the Hollow) 编写，部分内容可能借鉴 AI 输出，感谢你的阅读，等待你的试炼。*

**祝您好运，愿树洞之神与您常在。**

*本文档的全部文字在 [知识共享 署名—非商业性使用—相同方式共享 4.0 协议国际版 (CC BY-NC-SA 4.0)](https://creativecommons.org/licenses/by-nc-sa/4.0/) 之条款下提供，附加条款亦可能应用。请注意，若这些条款的英语版本与翻译版本之间，存在含意或解译上的差异，请以原始英语版本为准。*